<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel de Exibi√ß√£o</title>

    <!-- Firebase Compat (v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <style>
        /* layout base */
        
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background: #000;
            overflow: hidden;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            box-sizing: border-box;
        }
        /* garante que padding do superior seja considerado */
        
        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }
        
        #wrapper {
            display: flex;
            width: 100vw;
            height: 100vh;
            flex-direction: row;
            transition: all 0.5s ease-in-out;
        }
        
        body.rotated #wrapper {
            flex-direction: column;
            transform: rotate(90deg) translateY(-100%);
            transform-origin: top left;
            width: 100vh;
            height: 100vw;
            position: absolute;
        }
        /* √°rea de m√≠dia */
        
        #superior {
            /* centraliza a m√≠dia e permite contain sem cortes */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            flex: 1;
            background: #000;
            width: 100%;
            height: 100%;
            /* reserva espa√ßo para o rodap√© (portrait) - ser√° override em .rotated */
            padding-bottom: 60px;
        }
        /* wrapper para m√≠dia, facilita centraliza√ß√£o absoluta */
        
        #superior .media-wrap {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        
        .rodape {
            background: #fff;
            display: flex;
            align-items: center;
            padding: 1rem;
            color: #333;
            font-weight: 500;
            font-size: 1.1rem;
            box-sizing: border-box;
            z-index: 9999;
            /* garantido */
            /* transi√ß√£o suave caso queira animar */
            transition: all 0.25s ease;
        }
        /* ======= PORTRAIT (padr√£o) ======= */
        
        body:not(.rotated) .rodape {
            height: 60px;
            width: 100vw;
            position: fixed;
            /* <<< alterado para fixed */
            bottom: 0;
            left: 0;
            flex-direction: row;
            justify-content: space-between;
            z-index: 9999;
        }
        /* ======= LANDSCAPE ROTATED (barra lateral) ======= */
        
        body.rotated .rodape {
            width: 60px;
            height: 100vh;
            position: fixed;
            /* <<< alterado para fixed */
            top: 0;
            left: 0;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            z-index: 9999;
        }
        /* reserva espa√ßo para rodape no modo rotacionado */
        
        body.rotated #superior {
            padding-left: 60px;
            /* reserva o espa√ßo da barra lateral */
        }
        
        body.rotated .frase,
        body.rotated .info {
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        
        .frase,
        .info {
            white-space: nowrap;
        }
        
        .info {
            display: flex;
            flex-direction: column;
            font-size: 1rem;
            gap: 4px;
            text-align: right;
            align-items: flex-end;
        }
        
        .texto {
            background: transparent;
            color: #fff;
            font-size: 2rem;
            padding: 2rem;
            white-space: pre-wrap;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            text-align: left;
            line-height: 1.5;
            overflow: auto;
        }
        
        .imagem,
        .video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .fade {
            opacity: 0;
            transition: opacity 1s;
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .active {
            opacity: 1;
            z-index: 1;
        }
        /* ===== Responsividade autom√°tica para m√≠dias em #superior ===== */
        /* garante que os filhos preencham o container */
        
        #superior>* {
            position: absolute !important;
            inset: 0;
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
        }
        /* --- Troca para CONTAIN: mant√©m proporcionalidade, sem cortes --- */
        /* elementos de m√≠dia preenchendo o wrapper central, sem cortes */
        
        #superior img,
        #superior video,
        #superior .imagem,
        #superior .video {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain !important;
            object-position: center center !important;
            display: block;
            margin: 0 auto;
            position: relative !important;
            background: black;
        }
        /* Iframes costumam preencher, mantemos constraints para n√£o cortar */
        
        #superior iframe {
            width: 100% !important;
            height: 100% !important;
            transform-origin: center center;
            border: 0;
        }
        
        #superior .texto {
            padding: 2rem !important;
            overflow: auto !important;
            background: transparent !important;
            color: #fff !important;
        }
        
        #superior .fade {
            transition: opacity 1s !important;
            will-change: opacity;
        }
        
        body.rotated #superior>* {
            position: absolute !important;
            inset: 0;
            width: 100% !important;
            height: 100% !important;
        }
        /* pequenas melhorias visuais do overlay de carregamento */
        
        #carregandoOverlay {
            position: fixed;
            inset: 0;
            background: #0c0c0c;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            color: #e0e6ed;
            font-family: "Roboto Mono", "Consolas", monospace;
            text-align: center;
            transition: opacity 0.9s ease;
            will-change: opacity;
        }
        
        #logoCarregando {
            width: 420px;
            margin-bottom: 28px;
            opacity: 0.98;
            transition: opacity 0.8s ease;
        }
        
        .brilho {
            animation: brilho 2.2s ease-in-out infinite;
        }
        
        @keyframes brilho {
            0%,
            100% {
                opacity: 0.75;
            }
            50% {
                opacity: 1;
            }
        }
        
        .pontos {
            display: inline-block;
            width: auto;
            height: 2em;
            text-align: left;
            position: relative;
            margin-right: 8px;
            letter-spacing: -8px;
        }
        
        .pontos .dot {
            position: relative;
            left: 0;
            top: 0;
            font-size: 1.4em;
            line-height: 1;
            opacity: 0;
            transition: opacity 120ms linear;
            color: #9fded6;
        }
        
        .pontos .dot.on {
            opacity: 1;
        }
        
        .fadeOutShort {
            opacity: 0 !important;
            transition: opacity 360ms ease;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <div id="superior" class="quadrante"></div>
    </div>

    <div class="rodape">
        <div class="frase" id="fraseRodape">Seja Bem Vindo!</div>
        <div class="info">
            <div id="infoRodape">üìÖ 00/00/0000 - üïí 00:00</div>
            <div class="tempo" id="tempoRodape"><span id="cidadeClima">Carregando clima...</span></div>
        </div>
    </div>
    </div>

    <style>
        #carregandoTexto {
            font-size: 2.4rem;
            font-weight: 600;
        }
        
        #frase {
            font-size: 1.1rem;
        }
        
        .pontos .dot {
            font-size: 1.3rem;
        }
    </style>

    <script>
        /* ---------- Firebase init (compat) ---------- */
        const firebaseConfig = {
            apiKey: "AIzaSyDE1V9V4w0YbqJBgkeI7F4fN3sW_YokVBQ",
            authDomain: "midiaindoor-d2109.firebaseapp.com",
            databaseURL: "https://midiaindoor-d2109-default-rtdb.firebaseio.com",
            projectId: "midiaindoor-d2109",
            storageBucket: "midiaindoor-d2109.appspot.com",
            messagingSenderId: "549200922225",
            appId: "1:549200922225:web:731664468eb51fbdf2bdd0"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const firestore = (typeof firebase.firestore === 'function') ? firebase.firestore() : null;
        const db = firestore; // alias compat√≠vel com c√≥digo anterior

        function resolvePainelId() {
            const q = getQueryParam('painel') || getQueryParam('id') || getQueryParam('panel');
            return q || localStorage.getItem('painelId') || 'painel-default';
        }

        /* ---------- carregarDados: Firestore -> fallback RTDB ---------- */
        async function carregarDados(colecao, empresaId) {
            if (!empresaId) {
                console.error('empresaId ausente ao carregar dados da cole√ß√£o', colecao);
                return [];
            }

            if (db) {
                try {
                    const ref = db.collection('empresas').doc(empresaId).collection(colecao);
                    const snapshot = await ref.get();
                    const itens = [];
                    snapshot.forEach(doc => {
                        const data = doc.data() || {};
                        data._id = doc.id;
                        itens.push(data);
                    });
                    if (itens.length) return itens;
                } catch (err) {
                    console.warn('Erro Firestore (continuando fallback RTDB):', err);
                }
            }

            try {
                const r = await firebase.database().ref(`empresas/${empresaId}/${colecao}`).orderByChild('ordem').once('value');
                const v = r.val() || {};
                const items = Object.keys(v).map(k => ({
                    id: k,
                    ...v[k]
                }));
                items.sort((a, b) => (Number(a.ordem) || 0) - (Number(b.ordem) || 0));
                if (items && items.length) return items;

                const rRoot = await firebase.database().ref(`${colecao}`).orderByChild('ordem').once('value');
                const vRoot = rRoot.val() || {};
                const itemsRoot = Object.keys(vRoot).map(k => ({
                    id: k,
                    ...vRoot[k]
                }));
                itemsRoot.sort((a, b) => (Number(a.ordem) || 0) - (Number(b.ordem) || 0));
                return itemsRoot;
            } catch (e) {
                console.warn('RTDB read error for', colecao, e);
                return [];
            }
        }

        /* ---------- carrossel principal ---------- */
        async function iniciarCarrossel(colecao, containerId, empresaId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const itens = await carregarDados(colecao, empresaId);
            console.log('Itens carregados para carrossel', colecao, itens);
            if (!itens || !itens.length) {
                container.innerHTML = '<div style="color:#fff;padding:20px">Nenhuma m√≠dia para exibir.</div>';
                return;
            }

            let idx = 0;
            let timer = null;
            const len = itens.length;

            function limparTimer() {
                if (timer) {
                    clearTimeout(timer);
                    timer = null;
                }
            }

            function gerarEmbedSlidesFromUrl(u, defaultDelayMs = 12000) {
                if (!u) return null;
                try {
                    if (/\/presentation\/d\/e\/[^/]+\/embed/i.test(u) || /\/presentation\/d\/[^/]+\/embed/i.test(u)) {
                        return u;
                    }
                    if (u.includes('/pub')) {
                        let url = new URL(u);
                        if (!url.searchParams.has('start')) url.searchParams.set('start', 'true');
                        if (!url.searchParams.has('loop')) url.searchParams.set('loop', 'true');
                        if (!url.searchParams.has('delayms')) url.searchParams.set('delayms', String(defaultDelayMs));
                        url.pathname = url.pathname.replace(/\/pub$/i, '/embed');
                        return url.toString();
                    }
                    let m = u.match(/\/d\/e\/([a-zA-Z0-9_-]+)/);
                    if (m && m[1]) {
                        return `https://docs.google.com/presentation/d/e/${m[1]}/embed?start=true&loop=true&delayms=${defaultDelayMs}`;
                    }
                    m = u.match(/\/d\/([a-zA-Z0-9_-]+)/);
                    if (m && m[1]) {
                        return `https://docs.google.com/presentation/d/${m[1]}/embed?start=true&loop=true&delayms=${defaultDelayMs}`;
                    }
                } catch (e) {
                    console.warn('gerarEmbedSlidesFromUrl erro', e);
                }
                return null;
            }

            carregarOrientacao(window.empresaId);

            function criarElemento(item) {
                if (!item) return null;

                // Texto (frase/frame) tem prioridade
                if (item.texto) {
                    const d = document.createElement('div');
                    d.className = 'fade texto';
                    d.innerHTML = String(item.texto).replace(/\n/g, '<br>');
                    return d;
                }

                let src = String(item.embedUrl || item.url || item.imagem || item.video || '').trim();
                const tipo = String(item.tipo || '').toUpperCase();

                // Se for Google Slides em formato n√£o-embed, tenta gerar embedUrl
                if (src && /docs\.google\.com\/presentation/i.test(src)) {
                    const embed = gerarEmbedSlidesFromUrl(src, Number(item.delayMs || item.delay || 12000));
                    if (embed) src = embed;
                }

                // fun√ß√£o helper para criar um wrapper .media-wrap contendo o elemento
                function wrapMedia(el) {
                    const wrap = document.createElement('div');
                    wrap.className = 'media-wrap fade';
                    wrap.style.position = 'absolute';
                    wrap.style.inset = '0';
                    // garante que o elemento ocupe todo o wrapper e respeite object-fit
                    el.style.width = '100%';
                    el.style.height = '100%';
                    el.style.maxWidth = '100%';
                    el.style.maxHeight = '100%';
                    el.style.display = 'block';
                    wrap.appendChild(el);
                    return wrap;
                }

                // Caso especial para /d/e/<id>/embed -> usa /pub para ocultar barra inferior
                if (src && /\/presentation\/d\/e\/[^/]+\/embed/i.test(src)) {
                    const pubSrc = src.replace('/embed', '/pub');
                    const ifr = document.createElement('iframe');
                    ifr.src = pubSrc + (pubSrc.includes('?') ? '' : '?') + 'start=true&loop=true&delayms=12000';
                    ifr.frameBorder = '0';
                    ifr.setAttribute('allowfullscreen', 'true');
                    ifr.setAttribute('mozallowfullscreen', 'true');
                    ifr.setAttribute('webkitallowfullscreen', 'true');
                    ifr.style.width = '100%';
                    ifr.style.height = '110%';
                    ifr.style.marginTop = '-40px';
                    ifr.style.border = '0';
                    return wrapMedia(ifr);
                }

                if (src && /docs\.google\.com\/presentation\/d\/.+\/embed/i.test(src)) {
                    const containerIframe = document.createElement('div');
                    containerIframe.style.position = 'relative';
                    containerIframe.style.width = '100%';
                    containerIframe.style.height = '100%';
                    containerIframe.style.background = 'black';

                    const loading = document.createElement('div');
                    loading.style.top = '50%';
                    loading.style.left = '50%';
                    loading.style.transform = 'translate(-50%, -50%)';
                    loading.style.color = 'white';
                    loading.style.fontSize = '22px';
                    loading.style.fontFamily = 'sans-serif';
                    loading.style.opacity = '0.8';
                    containerIframe.appendChild(loading);

                    const ifr = document.createElement('iframe');
                    ifr.src = src;
                    ifr.style.width = '100%';
                    ifr.style.height = '100%';
                    ifr.style.border = '0';
                    ifr.style.opacity = '0';
                    ifr.allow = 'autoplay; encrypted-media; fullscreen';
                    ifr.setAttribute('allowfullscreen', 'true');
                    containerIframe.appendChild(ifr);

                    setTimeout(() => {
                        ifr.style.transition = 'opacity 1s ease';
                        ifr.style.opacity = '1';
                        loading.remove();
                    }, 1500);

                    // encapsula para manter comportamento consistente
                    const wrapper = document.createElement('div');
                    wrapper.className = 'media-wrap fade';
                    wrapper.style.position = 'absolute';
                    wrapper.style.inset = '0';
                    wrapper.appendChild(containerIframe);
                    return wrapper;
                }

                // V√çDEOS
                if (tipo === 'VIDEO' || /\.mp4($|\?)/i.test(src) || /\.(mp4|webm|ogg|mov)(\?.*)?$/i.test(src)) {
                    const v = document.createElement('video');
                    v.src = src;
                    v.autoplay = true;
                    v.muted = true;
                    v.playsInline = true;
                    v.controls = false;
                    v.preload = 'auto';

                    // estilos: ocupar o m√°ximo do wrapper sem cortar (contain)
                    v.style.objectFit = 'contain';
                    v.style.objectPosition = 'center center';
                    v.style.backgroundColor = 'black';
                    v.style.width = '100%';
                    v.style.height = '100%';
                    v.style.maxWidth = '100%';
                    v.style.maxHeight = '100%';
                    v.style.display = 'block';
                    v.style.position = 'relative';

                    const wrapped = wrapMedia(v);

                    // controlar t√©rmino, erro, timeout
                    v.onended = () => {
                        // deixa o carrossel cuidar da troca ‚Äî o caller controla timers
                    };
                    v.onerror = () => console.warn('Video erro (elemento):', src);

                    return wrapped;
                }

                // IMAGENS
                if (tipo === 'IMAGEM' || /\.(jpe?g|png|gif|webp|bmp|svg)(\?.*)?$/i.test(src)) {
                    const img = document.createElement('img');
                    img.src = src;
                    img.alt = item.nome || '';
                    img.style.objectFit = 'contain';
                    img.style.objectPosition = 'center center';
                    img.style.display = 'block';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    return wrapMedia(img);
                }

                // SITES / IFRAME gen√©rico
                if (/^https?:\/\//i.test(src)) {
                    const ifr = document.createElement('iframe');
                    ifr.src = src;
                    ifr.style.width = '100%';
                    ifr.style.height = '100%';
                    ifr.frameBorder = '0';
                    ifr.allow = 'fullscreen';
                    return wrapMedia(ifr);
                }

                // fallback nulo
                return null;
            }

            function registrarExibicaoSafe(item, ordem) {
                try {
                    const painelId = window.painelId || resolvePainelId();
                    const empId = window.empresaId || 'empresa1';
                    firebase.database().ref(`exibicoes/${empId}/${painelId}`).push({
                        timestamp: new Date().toISOString(),
                        tipo: item.tipo || 'desconhecido',
                        conteudo: (item.nome || item.url || item.imagem || '').slice(0, 120),
                        ordem: ordem
                    });
                } catch (e) {
                    console.warn('N√£o foi poss√≠vel registrar exibi√ß√£o:', e && e.message ? e.message : e);
                }
            }

            async function mostrarProximo() {
                limparTimer();

                let tentativas = 0;
                while (tentativas < len) {
                    const item = itens[idx];
                    const el = criarElemento(item);

                    if (el) {
                        // limpa e prepara container
                        container.innerHTML = '';
                        container.style.background = '#000';

                        // assegura que o elemento ocupe todo o container
                        el.style.position = 'absolute';
                        el.style.inset = '0';
                        el.style.width = '100%';
                        el.style.height = '100%';

                        container.appendChild(el);

                        // logs
                        registrarExibicaoSafe(item, idx);

                        // iniciar fade-in
                        setTimeout(() => el.classList.add('active'), 40);

                        // se for video dentro do wrapper, pega o v√≠deo real
                        const videoEl = el.querySelector && el.querySelector('video');

                        if (videoEl) {
                            // espera terminar ou faz timeout caso n√£o carregue
                            videoEl.onended = () => {
                                el.classList.remove('active');
                                setTimeout(() => {
                                    idx = (idx + 1) % len;
                                    mostrarProximo();
                                }, 1000);
                            };

                            videoEl.onerror = () => {
                                console.warn('Video erro, pulando item', item);
                                el.classList.remove('active');
                                setTimeout(() => {
                                    idx = (idx + 1) % len;
                                    mostrarProximo();
                                }, 1000);
                            };

                            // se o v√≠deo n√£o iniciar em X ms, pula
                            timer = setTimeout(() => {
                                try {
                                    if (!videoEl.readyState || videoEl.readyState < 2) {
                                        console.warn('Video timeout ‚Äî pulando');
                                        el.classList.remove('active');
                                        setTimeout(() => {
                                            idx = (idx + 1) % len;
                                            mostrarProximo();
                                        }, 1000);
                                    }
                                } catch (e) {
                                    idx = (idx + 1) % len;
                                    setTimeout(mostrarProximo, 0);
                                }
                            }, 8000);
                        } else {
                            const tag = (el.tagName || el.firstElementChild && el.firstElementChild.tagName || '').toUpperCase();
                            let delay;
                            if (tag === 'IMG' || tag === 'IFRAME' || tag === 'DIV') {
                                delay = 12000;
                            } else {
                                delay = Math.max(2000, Number(item.delayMs || item.delay || 7000));
                            }

                            timer = setTimeout(() => {
                                el.classList.remove('active');
                                setTimeout(() => {
                                    idx = (idx + 1) % len;
                                    mostrarProximo();
                                }, 1000);
                            }, delay);
                        }

                        return;
                    }

                    // se elemento inv√°lido, tenta pr√≥ximo
                    tentativas++;
                    idx = (idx + 1) % len;
                }

                console.warn('Nenhum item v√°lido encontrado.');
                container.innerHTML = '<div style="color:#fff;padding:20px">Nenhuma m√≠dia v√°lida encontrada.</div>';
            }

            mostrarProximo();
        }

        /* ---------- frases do rodap√© ---------- */
        async function carregarFrases() {
            const empresaId = window.empresaId || null;
            if (!empresaId) {
                console.warn('carregarFrases: empresaId n√£o definido ainda.');
                return;
            }

            const docs = await carregarDados("frases", empresaId);
            console.log('carregarFrases -> docs:', docs);

            if (!docs || !docs.length) {
                console.warn('Nenhuma frase encontrada para empresaId=', empresaId);
                document.getElementById("fraseRodape").textContent = 'Bem-vindo!';
                return;
            }

            const frases = docs.map(f => f.texto || f.frase || f.mensagem || f.text || f.content || '').filter(Boolean);

            if (!frases.length) {
                console.warn('Frases carregadas, mas nenhum campo reconhecido (texto/frase/mensagem). Veja docs no console.');
                console.log(docs);
                document.getElementById("fraseRodape").textContent = docs[0].texto || docs[0].frase || 'Mensagem dispon√≠vel';
                return;
            }

            let fraseIndex = 0;
            document.getElementById("fraseRodape").textContent = frases[fraseIndex];
            setInterval(() => {
                fraseIndex = (fraseIndex + 1) % frases.length;
                document.getElementById("fraseRodape").textContent = frases[fraseIndex];
            }, 15000);
        }

        /* ---------- rel√≥gio e clima ---------- */
        function atualizarRelogio() {
            const agora = new Date();
            const data = agora.toLocaleDateString();
            const hora = agora.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById("infoRodape").innerHTML = `üìÖ ${data} - üïí ${hora}`;
        }

        const cidades = [{
            nome: "S√£o Paulo",
            query: "Sao+Paulo"
        }, {
            nome: "Santos",
            query: "Santos+SP"
        }, {
            nome: "Guaruj√°",
            query: "Guaruja+SP"
        }, {
            nome: "Bertioga",
            query: "Bertioga+SP"
        }, {
            nome: "S√£o Sebasti√£o",
            query: "Sao+Sebastiao+SP"
        }, {
            nome: "Praia Grande",
            query: "Praia+Grande+SP"
        }, {
            nome: "Mongagu√°",
            query: "Mongagua+SP"
        }, {
            nome: "Ilha Comprida",
            query: "Ilha+Comprida+SP"
        }];
        let cidadeIndex = 0;

        async function atualizarTemperatura() {
            const cidade = cidades[cidadeIndex];
            try {
                const res = await fetch(`https://wttr.in/${cidade.query}?format=%t`);
                const temp = await res.text();
                if (temp.toLowerCase().includes("unknown location")) throw new Error("Indispon√≠vel");
                document.getElementById("cidadeClima").innerText = `üå°Ô∏è ${cidade.nome}: ${temp.replace('+', '')}`;
            } catch {
                document.getElementById("cidadeClima").innerText = `‚õÖ ${cidade.nome}: Dados n√£o dispon√≠veis`;
            }
            cidadeIndex = (cidadeIndex + 1) % cidades.length;
        }

        /* -------------------------
           Fun√ß√£o utilit√°ria: atualiza a URL no navegador sem reload
           Deve estar definida antes de resolveEmpresaIdForPage
           ------------------------- */
        function atualizarParametroNaUrl(paramName, paramValue) {
            try {
                if (paramValue === null || paramValue === undefined) return;
                const url = new URL(window.location.href);
                url.searchParams.set(paramName, String(paramValue));
                window.history.replaceState(null, '', url.toString());
            } catch (e) {
                console.warn('atualizarParametroNaUrl erro:', e);
            }
        }

        /* ---------- onAuthStateChanged: resolve empresaId e inicializa ---------- */
        auth.onAuthStateChanged(async user => {
            try {
                const userUid = user ? user.uid : null;

                window.empresaId = await resolveEmpresaIdForPage(userUid);
                window.painelId = resolvePainelId();

                console.log('Painel iniciado', {
                    user: user ? user.email : 'An√¥nimo',
                    empresaId: window.empresaId,
                    painelId: window.painelId
                });

                try {
                    await carregarOrientacao(window.empresaId);
                } catch (err) {
                    console.warn('Erro ao carregar orienta√ß√£o (continuando):', err);
                }

                iniciarCarrossel('midias', 'superior', window.empresaId);
                carregarFrases();
            } catch (e) {
                console.error('Erro na inicializa√ß√£o do painel dentro de onAuthStateChanged:', e);
                try {
                    iniciarCarrossel('midias', 'superior', window.empresaId || null);
                    carregarFrases();
                } catch (err) {
                    console.error('Falha ao iniciar carrossel/frases ap√≥s erro:', err);
                }
            }
        });

        function getQueryParam(name) {
            try {
                return new URLSearchParams(window.location.search).get(name);
            } catch {
                return null;
            }
        }

        // ---------- resolveEmpresaIdForPage (vers√£o completa recomendada) ----------
        async function resolveEmpresaIdForPage(userUid) {
            const q = getQueryParam('empresa') || getQueryParam('empresaId');
            if (q) {
                localStorage.setItem('empresaId', q);
                atualizarParametroNaUrl('empresaId', q);
                return q;
            }

            const ls = localStorage.getItem('empresaId');
            if (ls) {
                atualizarParametroNaUrl('empresaId', ls);
                return ls;
            }

            if (db && userUid) {
                try {
                    const doc = await db.collection('users').doc(userUid).get();
                    if (doc.exists && doc.data().empresaId) {
                        const empresaId = doc.data().empresaId;
                        localStorage.setItem('empresaId', empresaId);
                        atualizarParametroNaUrl('empresaId', empresaId);
                        return empresaId;
                    }
                } catch (e) {
                    console.warn('firestore users read err', e);
                }
            }

            if (userUid) {
                try {
                    const snap = await firebase.database().ref('usuarios/' + userUid).once('value');
                    const v = snap.val() || {};
                    if (v.empresaId) {
                        localStorage.setItem('empresaId', v.empresaId);
                        atualizarParametroNaUrl('empresaId', v.empresaId);
                        return v.empresaId;
                    }
                } catch (e) {
                    console.warn('RTDB usuarios read err', e);
                }
            }

            const padrao = 'empresa1';
            localStorage.setItem('empresaId', padrao);
            atualizarParametroNaUrl('empresaId', padrao);
            return padrao;
        }

        // ------------------------------------------------------------------------------------
        // ORIENTA√á√ÉO ‚Äî CARREGAR E APLICAR AUTOMATICAMENTE
        // ------------------------------------------------------------------------------------
        function aplicarOrientacao(orientacao) {
            if (orientacao === "landscape") {
                document.body.classList.add("rotated");
            } else {
                document.body.classList.remove("rotated");
            }
            try {
                localStorage.setItem('painel_orientacao', orientacao);
            } catch (e) {}
            // chama ajuste imediato
            ajustarMidiaParaNaoPassarDoRodape();
        }

        async function carregarOrientacao(empresaId) {
            try {
                if (!empresaId) {
                    const saved = localStorage.getItem('painel_orientacao');
                    if (saved) aplicarOrientacao(saved);
                    return;
                }
                const snap = await firebase.database()
                    .ref(`empresas/${empresaId}/painel/orientacao`)
                    .once("value");
                const orientacao = snap.val();
                if (orientacao) aplicarOrientacao(orientacao);
            } catch (e) {
                console.warn("Erro ao carregar orienta√ß√£o:", e);
            }
        }

        /* ---------- inicializa√ß√£o imediata/cron ---------- */
        atualizarRelogio();
        atualizarTemperatura();
        setInterval(atualizarRelogio, 10000);
        setInterval(atualizarTemperatura, 60000);

        // tecla V: alterna orienta√ß√£o e salva no Firebase (ignora se o usu√°rio est√° digitando)
        document.addEventListener('keydown', async(e) => {
            const tag = (document.activeElement && document.activeElement.tagName) || '';
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
            if (e.ctrlKey || e.metaKey || e.altKey) return;

            if (e.key && e.key.toLowerCase() === 'v') {
                const nova = document.body.classList.contains('rotated') ? 'portrait' : 'landscape';
                aplicarOrientacao(nova);

                if (window.empresaId) {
                    firebase.database()
                        .ref(`empresas/${window.empresaId}/painel/orientacao`)
                        .set(nova)
                        .then(() => console.log('Orienta√ß√£o salva no Firebase:', nova))
                        .catch(err => console.warn('Erro ao salvar orienta√ß√£o:', err));
                } else {
                    try {
                        localStorage.setItem('painel_orientacao', nova);
                    } catch (e) {}
                    console.warn('empresaId ausente ‚Äî orienta√ß√£o salva apenas localmente.');
                }
            }
        });

        /**
         * Ajusta m√≠dias para n√£o ultrapassar / ficar por tr√°s do rodap√©.
         * - Seleciona corretamente .rodape
         * - Em portrait limita altura dispon√≠vel (maxHeight)
         * - Em rotated limita largura dispon√≠vel (maxWidth)
         */
        function ajustarMidiaParaNaoPassarDoRodape() {
            const rodape = document.querySelector('.rodape');
            const midiaContainer = document.querySelector('#superior');

            if (!rodape || !midiaContainer) return;

            const isRotated = document.body.classList.contains('rotated');

            if (!isRotated) {
                // portrait: rodap√© embaixo
                const rodapeHeight = rodape.offsetHeight || 60;
                const telaAltura = window.innerHeight;
                const alturaDisponivel = Math.max(0, telaAltura - rodapeHeight);

                // vamos garantir padding-bottom consistente (caso algu√©m altere)
                midiaContainer.style.paddingBottom = rodapeHeight + 'px';

                // para cada v√≠deo ou imagem dentro do container
                document.querySelectorAll('#superior .media-wrap video, #superior .media-wrap img')
                    .forEach(midia => {

                        // remove ajustes anteriores
                        midia.style.height = '';
                        midia.style.width = '';
                        midia.style.maxHeight = '';
                        midia.style.maxWidth = '';
                        midia.style.objectFit = 'contain';
                        midia.style.transform = '';

                        // define que o m√°ximo da m√≠dia √© a √°rea √∫til (alt)
                        midia.style.maxHeight = alturaDisponivel + 'px';
                        midia.style.maxWidth = '100%';

                        // se ainda ultrapassar (casos raros), aplica leve redu√ß√£o
                        const atualAltura = midia.offsetHeight || midia.getBoundingClientRect().height;
                        if (atualAltura > alturaDisponivel) {
                            const fator = alturaDisponivel / atualAltura;
                            midia.style.transform = `scale(${fator})`;
                        }
                    });
            } else {
                // rotated: rodap√© lateral
                const rodapeWidth = rodape.offsetWidth || 60;
                const telaLargura = window.innerWidth;
                const larguraDisponivel = Math.max(0, telaLargura - rodapeWidth);

                // garante padding-left consistente
                midiaContainer.style.paddingLeft = rodapeWidth + 'px';

                document.querySelectorAll('#superior .media-wrap video, #superior .media-wrap img')
                    .forEach(midia => {
                        midia.style.height = '';
                        midia.style.width = '';
                        midia.style.maxHeight = '';
                        midia.style.maxWidth = '';
                        midia.style.objectFit = 'contain';
                        midia.style.transform = '';

                        // define que o m√°ximo da m√≠dia √© a √°rea √∫til (larg)
                        midia.style.maxWidth = larguraDisponivel + 'px';
                        midia.style.maxHeight = '100%';

                        // se ainda ultrapassar em largura, reduz
                        const atualLargura = midia.offsetWidth || midia.getBoundingClientRect().width;
                        if (atualLargura > larguraDisponivel) {
                            const fator = larguraDisponivel / atualLargura;
                            midia.style.transform = `scale(${fator})`;
                        }
                    });
            }
        }

        // roda no load
        window.addEventListener('load', () => {
            ajustarMidiaParaNaoPassarDoRodape();
            // dispara carrossel etc se autenticado ‚Äî j√° tratado em onAuthStateChanged
        });

        // roda sempre que trocar de m√≠dia
        document.addEventListener('DOMContentLoaded', () => {
            setInterval(ajustarMidiaParaNaoPassarDoRodape, 500);
        });

        // roda quando girar a tela / alterar tamanho
        window.addEventListener('resize', ajustarMidiaParaNaoPassarDoRodape);
    </script>

    <!-- TELA DE CARREGAMENTO -->
    <!-- TELA DE CARREGAMENTO -->
    <div id="telaCarregamento">
        <div id="conteudoCarregamento">
            <img src="./audio/logo.png" alt="Logo" id="logoCarregamento">
            <div id="textoTerminal"></div>
            <div id="cursorTerminal">‚ñà</div>
        </div>
    </div>

    <div id="carregandoOverlay" aria-live="polite">
        <img id="logoCarregando" src="./audio/logo.png" alt="Logo" />
        <div id="carregandoTexto" class="brilho">
            <span id="frase" aria-hidden="true">&gt;Iniciando sistema</span>
            <span class="pontos" aria-hidden="true" id="pontos">
                <span class="dot" id="dot1">.</span>
            <span class="dot" id="dot2">.</span>
            <span class="dot" id="dot3">.</span>
            </span>
        </div>
    </div>

    <script>
        (function() {
            const frases = [{
                txt: "Iniciando sistema",
                time: 2800
            }, {
                txt: "Estabelecendo Conex√£o Segura",
                time: 2200
            }, {
                txt: "Sincronizando com Database",
                time: 1500
            }, {
                txt: "Atualizando M√≠dias",
                time: 3200
            }, {
                txt: "Preparando interface",
                time: 1500
            }];

            const fraseEl = document.getElementById("frase");
            const pontosWrapper = document.getElementById("pontos");
            const logo = document.getElementById("logoCarregando");
            const overlay = document.getElementById("carregandoOverlay");
            const dots = [
                document.getElementById("dot1"),
                document.getElementById("dot2"),
                document.getElementById("dot3")
            ];

            const pontosSeq = ["", ".", "..", "...", "", ".", "..", "..."];
            let pontosInterval = null;
            let seqIdx = 0;

            function startPontosInterval(speed = 400) {
                clearInterval(pontosInterval);
                pontosInterval = setInterval(() => {
                    const current = pontosSeq[seqIdx];
                    dots.forEach((d, i) => {
                        d.style.opacity = i < current.length ? "1" : "0";
                    });
                    seqIdx = (seqIdx + 1) % pontosSeq.length;
                }, speed);
            }

            function stopPontosInterval() {
                clearInterval(pontosInterval);
                dots.forEach(d => d.style.opacity = "0");
            }

            let phraseIndex = 0;

            function showPhrase(i) {
                fraseEl.textContent = frases[i].txt;
                startPontosInterval(350);

                setTimeout(() => {
                    fraseEl.classList.add('fadeOutShort');
                    pontosWrapper.classList.add('fadeOutShort');

                    setTimeout(() => {
                        fraseEl.classList.remove('fadeOutShort');
                        pontosWrapper.classList.remove('fadeOutShort');
                        stopPontosInterval();

                        phraseIndex++;
                        if (phraseIndex < frases.length) {
                            setTimeout(() => showPhrase(phraseIndex), 200);
                        } else {
                            finishLoading();
                        }
                    }, 400);
                }, frases[i].time);
            }

            function finishLoading() {
                stopPontosInterval();
                fraseEl.textContent = "Painel pronto üöÄ";
                setTimeout(() => {
                    logo.style.transition = 'opacity 700ms ease';
                    logo.style.opacity = '0.12';
                    overlay.style.opacity = '0';
                    setTimeout(() => overlay.remove(), 800);
                }, 900);
            }

            window.addEventListener("load", () => {
                setTimeout(() => showPhrase(0), 300);
            });
        })();

        // sobe todos os v√≠deos um pouco
        document.querySelectorAll('#superior .media-wrap video').forEach(v => {
            v.style.transform = 'translateY(-20px)'; // ajuste conforme necess√°rio
            v.style.zIndex = '1000';
        });
    </script>
</body>

</html>
